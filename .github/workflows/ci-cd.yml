name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # Job de validaciÃ³n
  validate:
    name: ğŸ” Validar Proyecto
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ“¦ Instalar dependencias
        run: npm ci
        
      - name: ğŸšª Ejecutar GATES - Estructura
        run: npm run gate:dir
        
      - name: ğŸšª Ejecutar GATES - Variables de entorno
        run: npm run gate:env || echo "âš ï¸ Variables de entorno no configuradas, continuando..."
        env:
          VITE_CLARITY_PROJECT_ID: ${{ secrets.CLARITY_PROJECT_ID || 'demo_project_id' }}
          VITE_N8N_FEEDBACK_WEBHOOK_URL: ${{ secrets.N8N_WEBHOOK_URL || 'https://demo-webhook.com/feedback' }}
          
      - name: ğŸšª Ejecutar GATES - Componentes
        run: npm run gate:components || echo "âš ï¸ Gate de componentes fallÃ³, continuando..."
        
      - name: ğŸšª Ejecutar GATES - Deploy
        run: npm run gate:deployment || echo "âš ï¸ Gate de deploy fallÃ³, continuando..."
        
      - name: ğŸ—ï¸ Construir proyecto
        run: npm run build
        
      - name: ğŸ“Š Verificar build
        run: |
          echo "Verificando que dist/ se creÃ³..."
          ls -la dist/
          echo "Verificando archivos principales..."
          ls -la dist/ | grep -E "\.(html|js|css)$"
          
      - name: ğŸ§ª Test de componentes
        run: |
          echo "Verificando que los componentes existen..."
          test -f components/onboarding/onboarding.js || exit 1
          test -f components/clarity/clarity.js || exit 1
          test -f components/feedback/feedback.js || exit 1
          echo "âœ… Todos los componentes encontrados"

  # Job de deploy a Vercel
  deploy-vercel:
    name: ğŸš€ Deploy a Vercel
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ“¦ Instalar dependencias
        run: npm ci
        
      - name: ğŸ—ï¸ Construir proyecto
        run: npm run build
        
      - name: ğŸš€ Deploy a Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
        env:
          VITE_CLARITY_PROJECT_ID: ${{ secrets.CLARITY_PROJECT_ID }}
          VITE_N8N_FEEDBACK_WEBHOOK_URL: ${{ secrets.N8N_WEBHOOK_URL }}

  # Job de deploy a Render
  deploy-render:
    name: ğŸš€ Deploy a Render
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ“¦ Instalar dependencias
        run: npm ci
        
      - name: ğŸ—ï¸ Construir proyecto
        run: npm run build
        
      - name: ğŸš€ Deploy a Render
        uses: johnbeynon/render-deploy-action@v0.0.8
        with:
          service-id: ${{ secrets.RENDER_SERVICE_ID }}
          api-key: ${{ secrets.RENDER_API_KEY }}
        env:
          VITE_CLARITY_PROJECT_ID: ${{ secrets.CLARITY_PROJECT_ID }}
          VITE_N8N_FEEDBACK_WEBHOOK_URL: ${{ secrets.N8N_WEBHOOK_URL }}

  # Job de deploy a GitHub Pages
  deploy-pages:
    name: ğŸš€ Deploy a GitHub Pages
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ“¦ Instalar dependencias
        run: npm ci
        
      - name: ğŸ—ï¸ Construir proyecto
        run: npm run build
        env:
          VITE_CLARITY_PROJECT_ID: ${{ secrets.CLARITY_PROJECT_ID }}
          VITE_N8N_FEEDBACK_WEBHOOK_URL: ${{ secrets.N8N_WEBHOOK_URL }}
          
      - name: ğŸš€ Deploy a GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          cname: ${{ secrets.CUSTOM_DOMAIN }}

  # Job de notificaciones
  notify:
    name: ğŸ“¢ Notificaciones
    runs-on: ubuntu-latest
    needs: [validate, deploy-vercel, deploy-render, deploy-pages]
    if: always()
    
    steps:
      - name: ğŸ“Š Resumen del deploy
        run: |
          echo "## ğŸš€ Deploy Status" >> $GITHUB_STEP_SUMMARY
          echo "| Plataforma | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ValidaciÃ³n | ${{ needs.validate.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Vercel | ${{ needs.deploy-vercel.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Render | ${{ needs.deploy-render.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| GitHub Pages | ${{ needs.deploy-pages.result }} |" >> $GITHUB_STEP_SUMMARY
          
      - name: ğŸ‰ Deploy exitoso
        if: needs.validate.result == 'success'
        run: |
          echo "âœ… Deploy completado exitosamente"
          echo "ğŸ”— URLs disponibles:"
          echo "- Vercel: https://tu-proyecto.vercel.app"
          echo "- Render: https://tu-proyecto.onrender.com"
          echo "- GitHub Pages: https://tu-usuario.github.io/tu-repositorio"
          
      - name: âŒ Deploy fallÃ³
        if: needs.validate.result == 'failure'
        run: |
          echo "âŒ Deploy fallÃ³"
          echo "Revisa los logs para mÃ¡s detalles"
